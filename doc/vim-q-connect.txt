*vim-q-connect.txt*	Vim plugin for Q CLI context via Model Context Protocol

Author: Edouard Poor
License: MIT License

INTRODUCTION					*vim-q-connect*

vim-q-connect bridges Vim and Amazon Q CLI using Model Context Protocol (MCP)
for real-time AI-powered coding assistance. It provides bidirectional
communication enabling context sharing, inline annotations, navigation, and
intelligent code analysis directly in your editor.

Key Features:
- Real-time editor context sharing with Q CLI
- Inline virtual text annotations for code reviews and analysis
- Quickfix list integration for issue navigation
- Automatic file change detection and annotation updates
- Thread-safe bidirectional communication via Unix domain sockets

COMMANDS					*vim-q-connect-commands*

:QConnect					*:QConnect*
		Start tracking editor context and connect to Q CLI's MCP server.
		Enables autoread and sets up autocmds for context updates.

:QConnect!					*:QConnect!*
		Stop tracking editor context and disconnect from MCP server.
		Restores original autoread settings and removes autocmds.

:QVirtualTextClear				*:QVirtualTextClear*
		Clear all Q Connect virtual text annotations from current buffer.
		Removes all text properties of type 'q_virtual_text'.

:QHighlightsClear				*:QHighlightsClear*
		Clear all background highlights from current buffer.
		Removes all text properties used for highlighting.

:QQuickfixAnnotate				*:QQuickfixAnnotate*
		Manually annotate quickfix entries as virtual text.
		Usually called automatically when navigating quickfix entries.

:QQuickfixClear					*:QQuickfixClear*
		Clear quickfix list and all associated annotations.
		Removes all quickfix entries and closes quickfix window.

:QQuickfixAutoAnnotate[!]			*:QQuickfixAutoAnnotate*
		Enable or disable auto-annotation mode for quickfix entries.
		When enabled, annotations appear automatically when navigating
		between files that have quickfix entries.
		
		:QQuickfixAutoAnnotate		" Enable auto-annotation
		:QQuickfixAutoAnnotate!		" Disable auto-annotation

CONFIGURATION					*vim-q-connect-configuration*

g:vim_q_connect_socket_path			*g:vim_q_connect_socket_path*
		Custom socket path for MCP communication.
		Default: /tmp/vim-q-connect/{hash}/sock where {hash} is SHA256
		of current working directory.
>
		let g:vim_q_connect_socket_path = '/tmp/.vim-q-mcp.sock'
<

g:vim_q_connect_first_line_char			*g:vim_q_connect_first_line_char*
		Character displayed after emoji on first line of annotations.
		Default: '┤' (U+2524 Box Drawings Light Vertical And Left)
>
		let g:vim_q_connect_first_line_char = '>'
<

g:vim_q_connect_continuation_char		*g:vim_q_connect_continuation_char*
		Character displayed for continuation lines of multi-line annotations.
		Default: '│' (U+2502 Box Drawings Light Vertical)
>
		let g:vim_q_connect_continuation_char = '|'
<

HIGHLIGHT GROUPS				*vim-q-connect-highlights*

qtext						*hl-qtext*
		Highlight group for virtual text annotations.
		Default: ctermbg=237 ctermfg=250 cterm=italic
		         guibg=#2a2a2a guifg=#d0d0d0 gui=italic
>
		highlight qtext ctermbg=235 ctermfg=248 cterm=italic
<

USAGE						*vim-q-connect-usage*

Basic Connection:
1. Start Q CLI: `q chat`
2. In Vim: `:QConnect`
3. Q CLI now has real-time access to your editor context

The plugin automatically tracks:
- Current filename and cursor position
- Visual selections (start/end lines)
- File modification status
- Buffer type and encoding information
- Text changes and cursor movements

Context Updates:
Context is sent to Q CLI on these events:
- CursorMoved, CursorMovedI (cursor movement)
- ModeChanged (entering/leaving visual mode)
- TextChanged, TextChangedI (text modifications)

Virtual Text Annotations:
Q CLI can add inline annotations above code lines using the
`add_virtual_text` MCP tool. Annotations support:
- Multi-line text with proper indentation
- Emoji indicators for visual categorization
- Automatic line-width padding for full background
- Persistence across buffer switches

Quickfix Integration:
Q CLI can populate Vim's quickfix list using `add_to_quickfix` MCP tool:
- Entries are sorted by filename then line number
- Annotations appear automatically when navigating entries
- Line numbers update automatically when files change
- Use :cnext/:cprev to navigate between issues

File Change Detection:
The plugin enables autoread and automatically:
- Detects external file changes (git checkout, build tools, etc.)
- Reloads files and re-applies annotations at correct line numbers
- Updates quickfix entries to match new line numbers

MCP TOOLS					*vim-q-connect-mcp-tools*

The MCP server provides these tools to Q CLI:

get_editor_context()				*get_editor_context*
		Returns current editor state including filename, cursor position,
		visual selection, file metadata, and formatted code context.

goto_line(line_number, filename="")		*goto_line*
		Navigate to specific line/file in Vim. Handles window switching,
		tab navigation, and buffer management.

add_virtual_text(entries)			*add_virtual_text*
		Add inline annotations above code lines. Supports multi-line
		text, emoji indicators, and line-based positioning.

add_to_quickfix(entries)			*add_to_quickfix*
		Add entries to Vim's quickfix list. Supports line-based
		positioning and automatic sorting.

get_current_quickfix_entry()			*get_current_quickfix_entry*
		Get the quickfix entry currently focused by the user.
		Used for "fix this issue" workflows.

get_annotations_above_current_position()	*get_annotations_above_current_position*
		Get virtual text annotations above current cursor position.
		Returns closest annotations within 20 lines.

MCP PROMPTS					*vim-q-connect-prompts*

The MCP server provides pre-built prompts accessible via `/` in Q CLI:

/review [target]				*review-prompt*
		Comprehensive code review for security, quality, performance, and
		best practices. Populates quickfix list with issues and adds
		inline annotations. Optional target parameter for specific focus.
		
		Best used when: You want thorough analysis with actionable findings
		
		Features:
		- Checks security vulnerabilities, code quality, performance
		- Creates quickfix entries with emoji indicators
		- Multi-line descriptions with problem + solution
		- Navigate with :cnext/:cprev, fix with /fix

/explain [target]				*explain-prompt*
		Detailed explanation of what the current code does, how it works,
		and important details. Optional target parameter for specific focus.
		
		Best used when: Reading unfamiliar code or understanding complex logic
		
		Provides:
		- High-level purpose and step-by-step explanation
		- Important details and edge cases
		- Potential issues or improvements

/fix [target]					*fix-prompt*
		Intelligently fixes code issues. Auto-detects current quickfix
		issue or analyzes current code context. Optional target parameter
		for specific types of fixes.
		
		Best used when: You have specific issues to resolve
		
		Smart behavior:
		- Detects current quickfix entry and fixes that specific issue
		- Falls back to analyzing current editor context
		- Provides minimal, focused fixes with explanations
		- Follows best practices and coding standards

/doc [target]					*doc-prompt*
		Adds comprehensive documentation including docstrings, inline
		comments, and type hints. Optional target parameter for specific
		documentation focus.
		
		Best used when: Code lacks documentation or needs maintainability
		
		Adds:
		- Function/class docstrings following language conventions
		- Inline comments for complex logic
		- Type hints where applicable
		- Usage examples when helpful

Example Workflows:
>
	" Comprehensive code review
	You: /review
	Q: [Analyzes code, adds quickfix entries and inline annotations]
	You: :cnext  [Navigate to first issue]
	You: /fix    [Fix the current quickfix issue]

	" Understanding unfamiliar code
	You: [Select a complex function]
	You: /explain
	Q: [Explains the selected function in detail]

	" Adding documentation
	You: [Position cursor in undocumented function]
	You: /doc
	Q: [Adds docstrings, comments, and type hints]

	" Targeted fixes
	You: /fix "performance issues"
	Q: [Focuses specifically on performance problems]
<

TECHNICAL DETAILS				*vim-q-connect-technical*

Communication Protocol:
- Unix domain socket with JSON-RPC message format
- Newline-delimited messages for streaming
- Thread-safe request/response queues
- Automatic reconnection handling

Text Properties:
- Uses Vim's textprop system (requires Vim 8.1+)
- Property type 'q_virtual_text' with 'qtext' highlight
- Virtual text positioned 'above' target lines
- Automatic cleanup and duplicate prevention

State Management:
- Thread-safe VimState class with mutex protection
- Separate threads for socket server and message handling
- Request queues for bidirectional communication
- Response correlation using unique request IDs

Buffer Handling:
- Skips special buffers (terminal, NERDTree, etc.)
- Handles visual selections with proper start/end ordering
- Supports cross-file navigation and buffer switching
- Automatic buffer loading for quickfix line resolution

TROUBLESHOOTING					*vim-q-connect-troubleshooting*

Connection Issues:
- Ensure Q CLI is running: `q chat`
- Check socket exists: `ls -la /tmp/.vim-q-mcp.sock`
- Verify text properties: `:echo has('textprop')` should return 1
- Check channel status: `:echo ch_status(g:mcp_channel)`

Annotations Not Appearing:
- Verify Vim version 8.1+ with textprop support
- Check for conflicting plugins
- Manually refresh: `:QQuickfixAnnotate`
- Clear and reconnect: `:QConnect! | :QConnect`

Performance:
- Large files may cause slower context updates
- Virtual text rendering scales with window width
- Socket communication is optimized for low latency

EXAMPLES					*vim-q-connect-examples*

Basic Code Review Workflow:
>
	" In Q CLI
	You: /review
	Q: [Analyzes code, adds quickfix entries and annotations]
	
	" In Vim
	:cnext		" Navigate to first issue
	:cnext		" Navigate to next issue
	
	" In Q CLI  
	You: /fix
	Q: [Fixes the current quickfix issue]
<

Custom Socket Path and Display Characters:
>
	" In .vimrc
	let g:vim_q_connect_socket_path = '/tmp/my-vim-q.sock'
	let g:vim_q_connect_first_line_char = '▶'
	let g:vim_q_connect_continuation_char = '▎'
	
	" In Q CLI MCP config
	"env": {"SOCKET_DIR": "/tmp"}
<

Manual Annotation Management:
>
	:QVirtualTextClear		" Clear all annotations
	:QQuickfixAnnotate		" Re-annotate quickfix entries
	:QQuickfixClear			" Clear quickfix list and annotations
	:QQuickfixAutoAnnotate		" Enable auto-annotation mode
	:QQuickfixAutoAnnotate!		" Disable auto-annotation mode
	:QQuickfixClear			" Clear quickfix list and annotations
<

vim:tw=78:ts=8:ft=help:norl:
